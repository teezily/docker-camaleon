#!/bin/bash

if [[ $# -eq 0 ]] ; then
  echo 'define a branch to deploy'
  exit 0
fi
style="display: none;"
echo "deploy branch $@"
BRANCH=$@
DOKKU_APP=camaleon-pr
grep 'remote "dokku-pr"' .git/config || git remote add dokku-pr ssh://dokku@teezily.staging-dokku.teezily.com/camaleon-pr


echo "Configure ENV variable"
./bin/dokku-staging apps:create $DOKKU_APP
./bin/dokku-staging  config:set --no-restart $DOKKU_APP `./bin/dokku-staging config camaleon --shell`
./bin/dokku-staging  config:set --no-restart $DOKKU_APP TEEZILY_MYSQL_DATABASE=teezily_staging_pr TEEZILY_MYSQL_OLD_DATABASE=teezily_production CAMALEON_DEFAULT_HOSTNAME=$DOKKU_APP.staging-dokku.teezily.com CAMALEON_HOST=$DOKKU_APP.staging-dokku.teezily.com REDIS_PORT_6379_TCP_DB=1
git push dokku-pr -f $BRANCH:master
./bin/dokku-staging ps:stop $DOKKU_APP
./bin/dokku-staging run $DOKKU_APP rake db:copy_and_migrate
./bin/dokku-staging ps:start $DOKKU_APP

# connect to http://teezily-pr.staging-dokku.teezily.com/
